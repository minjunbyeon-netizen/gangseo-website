<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Cafe24 â†’ Firebase ë°ì´í„° ì—…ë¡œë“œ (NoAuth)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #0d1117;
            color: #e6edf3;
            padding: 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }

        h2 {
            color: #ffc107;
            margin: 30px 0 15px;
            font-size: 1.2em;
        }

        .subtitle {
            color: #8b949e;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        .log {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .ok {
            color: #3fb950;
        }

        .err {
            color: #f85149;
        }

        .info {
            color: #58a6ff;
        }

        .warn {
            color: #d29922;
        }

        .progress {
            background: #21262d;
            border-radius: 10px;
            height: 28px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #238636, #58a6ff);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            min-width: 40px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-num {
            font-size: 2em;
            font-weight: bold;
            color: #58a6ff;
        }

        .stat-label {
            color: #8b949e;
            margin-top: 5px;
        }

        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .warning-box {
            background: #1c1305;
            border: 1px solid #d29922;
            border-radius: 8px;
            padding: 16px;
            margin: 15px 0;
            color: #d29922;
        }
    </style>
</head>

<body>
    <h1>ğŸ”„ Cafe24 â†’ Firebase ë°ì´í„° ì—…ë¡œë“œ</h1>
    <p class="subtitle">ìˆ˜ì§‘ëœ ê²Œì‹œê¸€ + ìƒí’ˆ ë°ì´í„°ë¥¼ Firestoreì— ì—…ë¡œë“œí•©ë‹ˆë‹¤ (ì¸ì¦ ì—†ìŒ - ì„ì‹œ ê·œì¹™ ì‚¬ìš©)</p>

    <div class="warning-box">
        âš ï¸ <strong>ì¤‘ìš”:</strong> ì´ ë„êµ¬ëŠ” Firestore ê·œì¹™ì´ ì„ì‹œë¡œ ì—´ë ¤ ìˆì„ ë•Œë§Œ ì‘ë™í•©ë‹ˆë‹¤.
        ì—…ë¡œë“œ ì™„ë£Œ í›„ ë°˜ë“œì‹œ ë³´ì•ˆ ê·œì¹™ì„ ë³µì›í•˜ì„¸ìš”.
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-num" id="stat-total">0</div>
            <div class="stat-label">ì „ì²´</div>
        </div>
        <div class="stat-card">
            <div class="stat-num ok" id="stat-success">0</div>
            <div class="stat-label">ì„±ê³µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-num err" id="stat-error">0</div>
            <div class="stat-label">ì‹¤íŒ¨</div>
        </div>
        <div class="stat-card">
            <div class="stat-num warn" id="stat-skip">0</div>
            <div class="stat-label">ê±´ë„ˆëœ€</div>
        </div>
    </div>

    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width:0%">0%</div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ ì—…ë¡œë“œ ëŒ€ìƒ</h2>
        <p>âœ… ì•Œë¦¼ì‚¬í•­ (board_no=1)<br>âœ… êµ¬ì¸êµ¬ì§ (board_no=2)<br>âœ… ê°¤ëŸ¬ë¦¬ (board_no=8)<br>âœ… ìƒí’ˆ (3ê°œ
            ì¹´í…Œê³ ë¦¬: ì •ì¼í’ˆì°¸ê¸°ë¦„, ì•¡ìƒì°¨ì¦™, ë”ì¹˜ì»¤í”¼)</p>
        <br>
        <button id="btnStart" onclick="startUpload()">ğŸš€ ì „ì²´ ì—…ë¡œë“œ ì‹œì‘</button>
        <button id="btnVerify" onclick="verifyData()" style="background:linear-gradient(135deg,#1f6feb,#58a6ff)">ğŸ” ì—…ë¡œë“œ
            ê²€ì¦</button>
        <button id="btnClear" onclick="clearFirestore()" style="background:linear-gradient(135deg,#da3633,#f85149)">ğŸ—‘ï¸
            ê¸°ì¡´ ë°ì´í„° ì‚­ì œ</button>
    </div>

    <h2>ğŸ“ ì§„í–‰ ë¡œê·¸</h2>
    <div class="log" id="logArea"></div>

    <!-- Firebase SDK (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        // Firebase ì´ˆê¸°í™” (ì¸ì¦ ì—†ì´)
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let stats = { total: 0, success: 0, error: 0, skip: 0 };

        // ë³´ë“œ ë§¤í•‘ (íŒŒì¼ëª…ì— í•œê¸€ í¬í•¨)
        const BOARD_MAP = {
            1: { collection: 'notice', name: 'ì•Œë¦¼ì‚¬í•­', fileName: 'board_1_ì•Œë¦¼ì‚¬í•­.json' },
            2: { collection: 'jobs', name: 'êµ¬ì¸êµ¬ì§', fileName: 'board_2_êµ¬ì¸êµ¬ì§.json' },
            8: { collection: 'gallery', name: 'ê°¤ëŸ¬ë¦¬', fileName: 'board_8_ê°¤ëŸ¬ë¦¬.json' }
        };

        // ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
        const PRODUCT_MAP = [
            { cateNo: 23, name: 'ì •ì¼í’ˆì°¸ê¸°ë¦„', fileName: 'products_23_ì •ì¼í’ˆì°¸ê¸°ë¦„.json' },
            { cateNo: 25, name: 'ì•¡ìƒì°¨ì¦™', fileName: 'products_25_ì•¡ìƒì°¨ì¦™.json' },
            { cateNo: 53, name: 'ë”ì¹˜ì»¤í”¼', fileName: 'products_53_ë”ì¹˜ì»¤í”¼.json' }
        ];

        function log(msg, type = '') {
            const el = document.getElementById('logArea');
            el.innerHTML += `<div class="${type}">${new Date().toLocaleTimeString()} | ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-error').textContent = stats.error;
            document.getElementById('stat-skip').textContent = stats.skip;
            const pct = stats.total > 0 ? Math.round((stats.success + stats.error + stats.skip) / stats.total * 100) : 0;
            const bar = document.getElementById('progressBar');
            bar.style.width = pct + '%';
            bar.textContent = pct + '%';
        }

        // ===== ë©”ì¸ ì—…ë¡œë“œ =====
        async function startUpload() {
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            btn.textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
            stats = { total: 0, success: 0, error: 0, skip: 0 };

            try {
                log('ğŸš€ ë°ì´í„° ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');

                // 1) ê²Œì‹œíŒ ë°ì´í„° ì—…ë¡œë“œ
                for (const [boardNo, boardInfo] of Object.entries(BOARD_MAP)) {
                    await uploadBoard(parseInt(boardNo), boardInfo);
                }

                // 2) ìƒí’ˆ ë°ì´í„° ì—…ë¡œë“œ
                await uploadProducts();

                log('', '');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'ok');
                log(`ğŸ‰ ì—…ë¡œë“œ ì™„ë£Œ! ì„±ê³µ: ${stats.success}ê±´, ì‹¤íŒ¨: ${stats.error}ê±´, ê±´ë„ˆëœ€: ${stats.skip}ê±´`, 'ok');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'ok');
            } catch (error) {
                log(`âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: ${error.message}`, 'err');
                console.error(error);
            }

            btn.disabled = false;
            btn.textContent = 'ğŸš€ ì „ì²´ ì—…ë¡œë“œ ì‹œì‘';
        }

        // ===== ê²Œì‹œíŒ ì—…ë¡œë“œ =====
        async function uploadBoard(boardNo, boardInfo) {
            log(`ğŸ“‹ [${boardInfo.name}] ë°ì´í„° ë¡œë“œ ì¤‘...`, 'info');

            try {
                const response = await fetch(`migration_data/${boardInfo.fileName}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨`);
                }
                const data = await response.json();

                if (!data.articles || data.articles.length === 0) {
                    log(`  âš ï¸ ${boardInfo.name}: ë°ì´í„° ì—†ìŒ`, 'warn');
                    return;
                }

                const articles = data.articles;
                log(`  ğŸ“Š ${boardInfo.name}: ${articles.length}ê±´ ë°œê²¬`, 'info');
                stats.total += articles.length;
                updateStats();

                // ê²Œì‹œíŒ ë©”íƒ€ë¬¸ì„œ ìƒì„±
                await db.collection('boards').doc(boardInfo.collection).set({
                    name: boardInfo.name,
                    boardNo: boardNo,
                    totalArticles: articles.length,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                log(`  ğŸ“ ${boardInfo.name} ë©”íƒ€ë¬¸ì„œ ìƒì„± ì™„ë£Œ`, 'ok');

                // Batch write (400ê°œ ë‹¨ìœ„ - Firestore ì œí•œ 500)
                const batchSize = 400;

                for (let i = 0; i < articles.length; i += batchSize) {
                    const batch = db.batch();
                    const chunk = articles.slice(i, i + batchSize);

                    for (const article of chunk) {
                        const docRef = db.collection('boards')
                            .doc(boardInfo.collection)
                            .collection('articles')
                            .doc(String(article.id));

                        const docData = {
                            title: article.title || '',
                            content_html: article.content_html || '',
                            content_text: article.content_text || '',
                            date: article.date || '',
                            attachments: (article.attachments || []).map(att => ({
                                name: att.name || '',
                                url: att.url || ''
                            })),
                            source_url: article.source_url || '',
                            boardNo: boardNo,
                            boardName: boardInfo.name,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // ê°¤ëŸ¬ë¦¬ ì¸ë„¤ì¼
                        if (article.list_info && article.list_info.thumbnail) {
                            docData.thumbnail = article.list_info.thumbnail;
                        }

                        // êµ¬ì¸/êµ¬ì§ íƒ€ì…
                        if (article.list_info && article.list_info.type) {
                            docData.type = article.list_info.type;
                        }

                        batch.set(docRef, docData);
                    }

                    await batch.commit();
                    stats.success += chunk.length;
                    updateStats();
                    log(`  âœ… ${boardInfo.name}: ${Math.min(i + batchSize, articles.length)}/${articles.length}ê±´ ì™„ë£Œ`, 'ok');

                    // ì§§ì€ ë”œë ˆì´ (Firestore rate limit ë°©ì§€)
                    await new Promise(r => setTimeout(r, 200));
                }

                log(`âœ… [${boardInfo.name}] ì´ ${articles.length}ê±´ ì—…ë¡œë“œ ì™„ë£Œ!`, 'ok');
            } catch (error) {
                log(`âŒ [${boardInfo.name}] ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'err');
                stats.error++;
                updateStats();
            }
        }

        // ===== ìƒí’ˆ ì—…ë¡œë“œ =====
        async function uploadProducts() {
            log('ğŸ›ï¸ ìƒí’ˆ ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘...', 'info');

            for (const cat of PRODUCT_MAP) {
                try {
                    const response = await fetch(`migration_data/${cat.fileName}`);
                    if (!response.ok) {
                        log(`  âš ï¸ ${cat.name}: íŒŒì¼ ì—†ìŒ (HTTP ${response.status})`, 'warn');
                        continue;
                    }
                    const data = await response.json();

                    if (!data.products || data.products.length === 0) {
                        log(`  âš ï¸ ${cat.name}: ìƒí’ˆ ì—†ìŒ`, 'warn');
                        continue;
                    }

                    stats.total += data.products.length;
                    updateStats();

                    const batch = db.batch();

                    for (const product of data.products) {
                        const docRef = db.collection('products').doc(String(product.id));
                        batch.set(docRef, {
                            name: product.name || '',
                            price: product.price || '',
                            image: product.image || '',
                            summary: product.summary || '',
                            content_html: product.content_html || '',
                            category: cat.name,
                            cateNo: cat.cateNo,
                            source_url: product.source_url || '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    await batch.commit();
                    stats.success += data.products.length;
                    updateStats();
                    log(`  âœ… ${cat.name}: ${data.products.length}ê±´ ì™„ë£Œ`, 'ok');
                } catch (error) {
                    log(`  âŒ ${cat.name} ì‹¤íŒ¨: ${error.message}`, 'err');
                    stats.error++;
                    updateStats();
                }
            }
        }

        // ===== ì—…ë¡œë“œ ê²€ì¦ =====
        async function verifyData() {
            log('ğŸ” Firestore ë°ì´í„° ê²€ì¦ ì‹œì‘...', 'info');

            try {
                let totalDocs = 0;

                // ê²Œì‹œíŒ ê²€ì¦
                for (const [, boardInfo] of Object.entries(BOARD_MAP)) {
                    const snapshot = await db.collection('boards')
                        .doc(boardInfo.collection)
                        .collection('articles')
                        .get();
                    totalDocs += snapshot.size;
                    log(`  ğŸ“Š ${boardInfo.name}: ${snapshot.size}ê±´`, snapshot.size > 0 ? 'ok' : 'warn');

                    // ì²« ë¬¸ì„œ ìƒ˜í”Œ ì¶œë ¥
                    if (snapshot.size > 0) {
                        const firstDoc = snapshot.docs[0].data();
                        log(`     â””â”€ ìƒ˜í”Œ: "${firstDoc.title}" (${firstDoc.date})`, 'info');
                    }
                }

                // ìƒí’ˆ ê²€ì¦
                const prodSnap = await db.collection('products').get();
                totalDocs += prodSnap.size;
                log(`  ğŸ“Š ìƒí’ˆ: ${prodSnap.size}ê±´`, prodSnap.size > 0 ? 'ok' : 'warn');

                if (prodSnap.size > 0) {
                    const firstProd = prodSnap.docs[0].data();
                    log(`     â””â”€ ìƒ˜í”Œ: "${firstProd.name}" (${firstProd.category})`, 'info');
                }

                // boards ë©”íƒ€ë¬¸ì„œ ê²€ì¦
                const boardsMeta = await db.collection('boards').get();
                log(`  ğŸ“ ê²Œì‹œíŒ ë©”íƒ€ë¬¸ì„œ: ${boardsMeta.size}ê±´`, 'info');

                log('', '');
                log(`ğŸ” ê²€ì¦ ì™„ë£Œ: ì´ ${totalDocs}ê±´ í™•ì¸ (ê²Œì‹œê¸€ + ìƒí’ˆ)`, totalDocs > 0 ? 'ok' : 'err');
            } catch (error) {
                log(`âŒ ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'err');
                console.error(error);
            }
        }

        // ===== ë°ì´í„° ì‚­ì œ =====
        async function clearFirestore() {
            if (!confirm('âš ï¸ Firestoreì˜ ëª¨ë“  ê²Œì‹œíŒ + ìƒí’ˆ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                log('ğŸ—‘ï¸ ë°ì´í„° ì‚­ì œ ì‹œì‘...', 'warn');

                for (const [, boardInfo] of Object.entries(BOARD_MAP)) {
                    log(`  ğŸ—‘ï¸ ${boardInfo.name} ì‚­ì œ ì¤‘...`, 'warn');
                    const snapshot = await db.collection('boards').doc(boardInfo.collection).collection('articles').get();

                    // 400ê°œ ë‹¨ìœ„ batch ì‚­ì œ
                    const docs = snapshot.docs;
                    for (let i = 0; i < docs.length; i += 400) {
                        const batch = db.batch();
                        docs.slice(i, i + 400).forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }

                    // ë©”íƒ€ë¬¸ì„œ ì‚­ì¿ 
                    await db.collection('boards').doc(boardInfo.collection).delete();
                    log(`  âœ… ${boardInfo.name}: ${snapshot.size}ê±´ ì‚­ì œ`, 'ok');
                }

                log('  ğŸ—‘ï¸ ìƒí’ˆ ì‚­ì œ ì¤‘...', 'warn');
                const prodSnap = await db.collection('products').get();
                const docs = prodSnap.docs;
                for (let i = 0; i < docs.length; i += 400) {
                    const batch = db.batch();
                    docs.slice(i, i + 400).forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                log(`  âœ… ìƒí’ˆ: ${prodSnap.size}ê±´ ì‚­ì œ`, 'ok');

                log('âœ… ì „ì²´ ì‚­ì œ ì™„ë£Œ', 'ok');
            } catch (error) {
                log(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'err');
                console.error(error);
            }
        }
    </script>
</body>

</html>