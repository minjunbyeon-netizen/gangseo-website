<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ë¶€ì‚°ê°•ì„œì‹œë‹ˆì–´í´ëŸ½</title>
    <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">
                <img src="../images/logo/origin.jpg" alt="ë¶€ì‚°ê°•ì„œì‹œë‹ˆì–´í´ëŸ½" onerror="this.style.display='none'">
            </div>
            <h1>ë¶€ì‚°ê°•ì„œì‹œë‹ˆì–´í´ëŸ½</h1>
            <p class="login-subtitle">ê´€ë¦¬ì í˜ì´ì§€</p>
            <button id="btnGoogleLogin" class="btn-google" onclick="googleLogin()">
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
            <p class="login-hint">í—ˆìš©ëœ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- ë©”ì¸ ê´€ë¦¬ì í™”ë©´ -->
    <div id="adminScreen" class="admin-screen" style="display:none">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="admin-header">
            <div class="header-left">
                <img src="../images/logo/origin.jpg" alt="ë¡œê³ " class="header-logo-img"
                    onerror="this.style.display='none'">
                <h1>ë¶€ì‚°ê°•ì„œì‹œë‹ˆì–´í´ëŸ½ <span>ê´€ë¦¬ì</span></h1>
            </div>
            <div class="header-right">
                <a href="../index.html" target="_blank" class="btn-site">ì‚¬ì´íŠ¸ ë³´ê¸° â†—</a>
                <span id="userEmail" class="user-email"></span>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>

        <!-- ì‚¬ì´ë“œë°” + ì½˜í…ì¸  -->
        <div class="admin-body">
            <nav class="sidebar">
                <div class="sidebar-title">ê²Œì‹œíŒ ê´€ë¦¬</div>
                <a href="#" class="nav-item active" data-board="notice" onclick="switchBoard('notice', this)">
                    <span class="nav-text">ì•Œë¦¼ì‚¬í•­</span>
                    <span class="nav-count" id="count-notice">0</span>
                </a>
                <a href="#" class="nav-item" data-board="jobs" onclick="switchBoard('jobs', this)">
                    <span class="nav-text">êµ¬ì¸êµ¬ì§</span>
                    <span class="nav-count" id="count-jobs">0</span>
                </a>
                <a href="#" class="nav-item" data-board="gallery" onclick="switchBoard('gallery', this)">
                    <span class="nav-text">ê°¤ëŸ¬ë¦¬</span>
                    <span class="nav-count" id="count-gallery">0</span>
                </a>
                <a href="#" class="nav-item" data-board="products" onclick="switchBoard('products', this)">
                    <span class="nav-text">ìƒí’ˆë“±ë¡</span>
                    <span class="nav-count" id="count-products">0</span>
                </a>
                <div class="sidebar-divider"></div>
                <div class="sidebar-title">ì‹ ì²­ ê´€ë¦¬</div>
                <a href="#" class="nav-item" data-board="applications" onclick="switchToApplications(this)">
                    <span class="nav-text">ì°¸ì—¬ì‹ ì²­ì„œ</span>
                    <span class="nav-count nav-count-new" id="count-applications">0</span>
                </a>
            </nav>

            <main class="content">
                <!-- ëª©ë¡ ë·° -->
                <div id="listView">
                    <div class="content-header">
                        <h2 id="boardTitle">ì „ì²´ ê²Œì‹œë¬¼ ëª©ë¡</h2>
                        <div class="header-actions">
                            <button class="btn-primary" onclick="showWriteForm()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2.5">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                ê¸€ ì‘ì„±
                            </button>
                        </div>
                    </div>
                    <div class="list-info">
                        <span id="totalCount">ì´ <strong>0</strong>ê±´</span>
                    </div>
                    <div class="article-list" id="articleList">
                        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ì°¸ì—¬ì‹ ì²­ì„œ í™•ì¸ ë·° -->
                <div id="applicationsView" style="display:none">
                    <div class="content-header">
                        <h2>ì°¸ì—¬ì‹ ì²­ì„œ í™•ì¸ëª©ë¡</h2>
                        <div class="header-actions">
                            <span id="appTotalCount">ì´ <strong>0</strong>ê±´</span>
                            <select id="appStatusFilter" onchange="filterApplications()">
                                <option value="all">ì „ì²´</option>
                                <option value="new">ì‹ ê·œ</option>
                                <option value="checked">í™•ì¸ì™„ë£Œ</option>
                                <option value="contacted">ì—°ë½ì™„ë£Œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="article-list" id="applicationsList">
                        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- ì‹ ì²­ì„œ ìƒì„¸ ë·° -->
                <div id="appDetailView" style="display:none">
                    <div class="content-header">
                        <h2>ì‹ ì²­ì„œ ìƒì„¸</h2>
                    </div>
                    <div id="appDetailContent" class="app-detail-content"></div>
                </div>

                <!-- ê¸€ ì‘ì„±/ìˆ˜ì • í¼ -->
                <div id="writeView" style="display:none">
                    <div class="content-header">
                        <h2 id="formTitle">ì•Œë¦¼ì‚¬í•­</h2>
                    </div>
                    <div class="write-form">
                        <input type="hidden" id="editId" value="">
                        <table class="form-table">
                            <tbody>
                                <tr>
                                    <th>ì œëª©</th>
                                    <td>
                                        <input type="text" id="articleTitle" placeholder="ê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                                            class="form-input">
                                        <label class="checkbox-label" id="noticeCheckWrap" style="display:none">
                                            <input type="checkbox" id="isNotice"> ê³µì§€ì‚¬í•­
                                        </label>
                                    </td>
                                </tr>
                                <tr id="typeRow" style="display:none">
                                    <th>ìœ í˜•</th>
                                    <td>
                                        <select id="articleType" class="form-select">
                                            <option value="êµ¬ì¸">êµ¬ì¸</option>
                                            <option value="êµ¬ì§">êµ¬ì§</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- ì—ë””í„° -->
                        <div class="editor-wrap">
                            <div class="editor-toolbar">
                                <select class="toolbar-select" onchange="execFontSize(this.value)">
                                    <option value="3">12</option>
                                    <option value="4" selected>14</option>
                                    <option value="5">18</option>
                                    <option value="6">24</option>
                                    <option value="7">36</option>
                                </select>
                                <span class="toolbar-sep"></span>
                                <button type="button" onclick="execCmd('bold')" title="êµµê²Œ"><b>B</b></button>
                                <button type="button" onclick="execCmd('italic')" title="ê¸°ìš¸ì„"><i>I</i></button>
                                <button type="button" onclick="execCmd('underline')" title="ë°‘ì¤„"><u>U</u></button>
                                <button type="button" onclick="execFontColor()" title="ê¸€ììƒ‰">A<span
                                        class="color-bar"></span></button>
                                <span class="toolbar-sep"></span>
                                <button type="button" onclick="execCmd('insertUnorderedList')" title="ê¸€ë¨¸ë¦¬ ê¸°í˜¸">â˜°</button>
                                <button type="button" onclick="execCmd('insertOrderedList')" title="ë²ˆí˜¸ ëª©ë¡">â˜·</button>
                                <span class="toolbar-sep"></span>
                                <button type="button" onclick="execCmd('justifyLeft')" title="ì™¼ìª½ ì •ë ¬">â‰¡</button>
                                <button type="button" onclick="execCmd('justifyCenter')" title="ê°€ìš´ë° ì •ë ¬">â‰¡</button>
                                <button type="button" onclick="execCmd('justifyRight')" title="ì˜¤ë¥¸ìª½ ì •ë ¬">â‰¡</button>
                                <span class="toolbar-sep"></span>
                                <button type="button" onclick="insertImage()" title="ì´ë¯¸ì§€ ì‚½ì…" class="btn-img">ğŸ–¼ï¸
                                    ì´ë¯¸ì§€</button>
                            </div>
                            <div id="articleContent" class="editor" contenteditable="true"></div>
                            <div class="editor-footer">
                                <span class="char-count">ê¸€ì : <span id="charCount">0</span></span>
                            </div>
                        </div>

                        <!-- ì²¨ë¶€íŒŒì¼ -->
                        <table class="form-table attach-table">
                            <tbody>
                                <tr>
                                    <th>ì²¨ë¶€íŒŒì¼1</th>
                                    <td>
                                        <input type="file" id="imageUpload1" accept="image/*"
                                            onchange="handleFileSelect(this, 1)">
                                        <span class="file-name" id="fileName1">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>ì²¨ë¶€íŒŒì¼2</th>
                                    <td>
                                        <input type="file" id="imageUpload2" accept="image/*"
                                            onchange="handleFileSelect(this, 2)">
                                        <span class="file-name" id="fileName2">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
                        <div class="form-actions">
                            <button class="btn-cancel" onclick="cancelWrite()">ì·¨ì†Œ</button>
                            <button class="btn-submit" onclick="saveArticle()">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <script src="../js/firebase-config.js"></script>

    <script>
        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // í—ˆìš©ëœ ê´€ë¦¬ì ì´ë©”ì¼ ëª©ë¡
        const ALLOWED_ADMINS = [
            'minjunbyeon@gmail.com',
            // ì—¬ê¸°ì— ë‹´ë‹¹ì ì´ë©”ì¼ ì¶”ê°€
        ];

        let currentBoard = 'notice';
        let currentArticles = [];
        let uploadedFiles = [null, null];

        const BOARD_TITLES = {
            notice: 'ì•Œë¦¼ì‚¬í•­',
            jobs: 'êµ¬ì¸êµ¬ì§',
            gallery: 'ê°¤ëŸ¬ë¦¬',
            products: 'ìƒí’ˆë“±ë¡'
        };

        // ===== ì¸ì¦ =====
        auth.onAuthStateChanged(user => {
            if (user && ALLOWED_ADMINS.includes(user.email)) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminScreen').style.display = 'flex';
                document.getElementById('userEmail').textContent = user.email;
                loadArticles(currentBoard);
                loadCounts();
            } else if (user) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤.');
                auth.signOut();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminScreen').style.display = 'none';
            }
        });

        async function googleLogin() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        function logout() {
            auth.signOut();
        }

        // ===== ê²Œì‹œíŒ ì „í™˜ =====
        function switchBoard(board, el) {
            currentBoard = board;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');

            document.getElementById('boardTitle').textContent = 'ì „ì²´ ê²Œì‹œë¬¼ ëª©ë¡';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('writeView').style.display = 'none';

            // êµ¬ì¸êµ¬ì§ ìœ í˜• í‘œì‹œ
            const typeRow = document.getElementById('typeRow');
            if (typeRow) typeRow.style.display = board === 'jobs' ? '' : 'none';

            // ê³µì§€ ì²´í¬ë°•ìŠ¤ - ì•Œë¦¼ì‚¬í•­ë§Œ
            const noticeWrap = document.getElementById('noticeCheckWrap');
            if (noticeWrap) noticeWrap.style.display = board === 'notice' ? 'inline-flex' : 'none';

            loadArticles(board);
        }

        // ===== ê¸€ ëª©ë¡ ë¡œë“œ =====
        async function loadArticles(board) {
            const container = document.getElementById('articleList');
            container.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const snapshot = await db.collection('boards').doc(board).collection('articles')
                    .orderBy('date', 'desc')
                    .limit(50)
                    .get();

                currentArticles = [];
                snapshot.forEach(doc => {
                    currentArticles.push({ id: doc.id, ...doc.data() });
                });

                document.getElementById('totalCount').innerHTML =
                    `ì´ <strong>${currentArticles.length}</strong>ê±´`;
                renderArticleList(container, currentArticles);
            } catch (error) {
                container.innerHTML = `<div class="error">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function loadCounts() {
            for (const board of ['notice', 'jobs', 'gallery', 'products']) {
                try {
                    const snapshot = await db.collection('boards').doc(board).collection('articles').get();
                    document.getElementById(`count-${board}`).textContent = snapshot.size;
                } catch (e) {
                    // ë¬´ì‹œ
                }
            }
        }

        function renderArticleList(container, articles) {
            if (articles.length === 0) {
                container.innerHTML = '<div class="empty">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = `
                <table class="article-table">
                    <thead>
                        <tr>
                            <th class="col-check"><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)"></th>
                            <th class="col-num">ë²ˆí˜¸</th>
                            <th class="col-category">ë¶„ë¥˜</th>
                            <th class="col-title">ì œëª©</th>
                            <th class="col-preview">ê°„í¸ë³´ê¸°</th>
                            <th class="col-date">ì‘ì„±ì¼</th>
                            <th class="col-actions">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            articles.forEach((article, index) => {
                const typeTag = article.type
                    ? `<span class="type-tag type-${article.type === 'êµ¬ì¸' ? 'hiring' : 'seeking'}">${article.type}</span>`
                    : `<span class="type-tag type-default">${BOARD_TITLES[currentBoard]}</span>`;
                const isNotice = article.isNotice ? '<span class="badge-notice">ê³µì§€</span>' : '';
                const num = articles.length - index;

                html += `
                    <tr>
                        <td class="col-check"><input type="checkbox" class="article-check" value="${article.id}"></td>
                        <td class="col-num">${num}</td>
                        <td class="col-category">${typeTag}</td>
                        <td class="col-title">
                            ${isNotice}
                            <a href="#" onclick="previewArticle('${article.id}'); return false;">${escapeHtml(article.title)}</a>
                        </td>
                        <td class="col-preview">
                            <button class="btn-preview" onclick="previewArticle('${article.id}')">ë¯¸ë¦¬ë³´ê¸°</button>
                        </td>
                        <td class="col-date">${article.date || '-'}</td>
                        <td class="col-actions">
                            <button class="btn-edit" onclick="editArticle('${article.id}')">ìˆ˜ì •</button>
                            <button class="btn-delete" onclick="deleteArticle('${article.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function toggleCheckAll(el) {
            document.querySelectorAll('.article-check').forEach(cb => cb.checked = el.checked);
        }

        // ===== ë¯¸ë¦¬ë³´ê¸° =====
        function previewArticle(id) {
            const article = currentArticles.find(a => a.id === id);
            if (!article) return;

            const win = window.open('', '_blank', 'width=700,height=600,scrollbars=yes');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${escapeHtml(article.title)}</title>
                    <style>
                        body { font-family: 'Noto Sans KR', sans-serif; padding: 30px; line-height: 1.7; color: #333; max-width: 700px; margin: 0 auto; }
                        h1 { font-size: 20px; border-bottom: 2px solid #333; padding-bottom: 12px; margin-bottom: 8px; }
                        .meta { color: #888; font-size: 13px; margin-bottom: 20px; }
                        .content { font-size: 14px; }
                        .content img { max-width: 100%; height: auto; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHtml(article.title)}</h1>
                    <div class="meta">ì‘ì„±ì¼: ${article.date || '-'}</div>
                    <div class="content">${article.content_html || article.content || '<p>ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div>
                </body>
                </html>
            `);
        }

        // ===== ê¸€ ì‘ì„± =====
        function showWriteForm() {
            document.getElementById('listView').style.display = 'none';
            document.getElementById('writeView').style.display = 'block';
            document.getElementById('formTitle').textContent = BOARD_TITLES[currentBoard];
            document.getElementById('editId').value = '';
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').innerHTML = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('fileName1').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            document.getElementById('fileName2').textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            uploadedFiles = [null, null];

            document.getElementById('typeRow').style.display = currentBoard === 'jobs' ? '' : 'none';
            document.getElementById('noticeCheckWrap').style.display = currentBoard === 'notice' ? 'inline-flex' : 'none';
            document.getElementById('isNotice').checked = false;
        }

        function cancelWrite() {
            document.getElementById('listView').style.display = 'block';
            document.getElementById('writeView').style.display = 'none';
        }

        async function saveArticle() {
            const title = document.getElementById('articleTitle').value.trim();
            const contentHtml = document.getElementById('articleContent').innerHTML;
            const contentText = document.getElementById('articleContent').innerText.trim();
            const editId = document.getElementById('editId').value;

            if (!title) { alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            if (!contentText) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

            // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
            const saveBtn = document.querySelector('.btn-submit');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';

            const data = {
                title,
                content_html: contentHtml,
                content_text: contentText,
                date: new Date().toISOString().split('T')[0],
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (currentBoard === 'jobs') {
                data.type = document.getElementById('articleType').value;
            }

            if (currentBoard === 'notice') {
                data.isNotice = document.getElementById('isNotice').checked;
            }

            // ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ
            const attachments = [];
            for (let i = 0; i < uploadedFiles.length; i++) {
                if (uploadedFiles[i]) {
                    try {
                        const file = uploadedFiles[i];
                        const path = `board_images/${currentBoard}/${Date.now()}_${file.name}`;
                        const ref = storage.ref(path);
                        const snapshot = await ref.put(file);
                        const url = await snapshot.ref.getDownloadURL();
                        attachments.push({ name: file.name, url });
                    } catch (err) {
                        console.error('File upload error:', err);
                    }
                }
            }
            if (attachments.length > 0) {
                data.attachments = attachments;
            }

            try {
                if (editId) {
                    await db.collection('boards').doc(currentBoard).collection('articles').doc(editId).update(data);
                    alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('boards').doc(currentBoard).collection('articles').add(data);
                    alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                cancelWrite();
                loadArticles(currentBoard);
                loadCounts();
            } catch (error) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ì €ì¥';
            }
        }

        // ===== ê¸€ ìˆ˜ì • =====
        async function editArticle(id) {
            const article = currentArticles.find(a => a.id === id);
            if (!article) return;

            document.getElementById('listView').style.display = 'none';
            document.getElementById('writeView').style.display = 'block';
            document.getElementById('formTitle').textContent = BOARD_TITLES[currentBoard] + ' ìˆ˜ì •';
            document.getElementById('editId').value = id;
            document.getElementById('articleTitle').value = article.title;
            document.getElementById('articleContent').innerHTML = article.content_html || '';
            document.getElementById('typeRow').style.display = currentBoard === 'jobs' ? '' : 'none';
            document.getElementById('noticeCheckWrap').style.display = currentBoard === 'notice' ? 'inline-flex' : 'none';

            if (article.type) {
                document.getElementById('articleType').value = article.type;
            }
            if (currentBoard === 'notice') {
                document.getElementById('isNotice').checked = article.isNotice || false;
            }

            updateCharCount();
        }

        // ===== ê¸€ ì‚­ì œ =====
        async function deleteArticle(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await db.collection('boards').doc(currentBoard).collection('articles').doc(id).delete();
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadArticles(currentBoard);
                loadCounts();
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ===== ì—ë””í„° ê¸°ëŠ¥ =====
        function execCmd(command) {
            document.execCommand(command, false, null);
            document.getElementById('articleContent').focus();
        }

        function execFontSize(size) {
            document.execCommand('fontSize', false, size);
            document.getElementById('articleContent').focus();
        }

        function execFontColor() {
            const color = prompt('ìƒ‰ìƒ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: #ff0000, red)', '#000000');
            if (color) {
                document.execCommand('foreColor', false, color);
                document.getElementById('articleContent').focus();
            }
        }

        async function insertImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const path = `board_images/${currentBoard}/${Date.now()}_${file.name}`;
                    const ref = storage.ref(path);
                    const snapshot = await ref.put(file);
                    const url = await snapshot.ref.getDownloadURL();
                    document.execCommand('insertImage', false, url);
                } catch (err) {
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
                }
            };
            input.click();
        }

        function handleFileSelect(input, index) {
            const file = input.files[0];
            const nameSpan = document.getElementById(`fileName${index}`);
            if (file) {
                uploadedFiles[index - 1] = file;
                nameSpan.textContent = file.name;
            } else {
                uploadedFiles[index - 1] = null;
                nameSpan.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
            }
        }

        // ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        function updateCharCount() {
            const text = document.getElementById('articleContent').innerText;
            document.getElementById('charCount').textContent = text.length;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('articleContent');
            if (editor) {
                editor.addEventListener('input', updateCharCount);
            }
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== ì°¸ì—¬ì‹ ì²­ì„œ ê´€ë¦¬ =====
        let allApplications = [];

        function switchToApplications(el) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (el) el.classList.add('active');

            document.getElementById('listView').style.display = 'none';
            document.getElementById('writeView').style.display = 'none';
            document.getElementById('applicationsView').style.display = 'block';
            document.getElementById('appDetailView').style.display = 'none';

            loadApplications();
        }

        async function loadApplications() {
            const container = document.getElementById('applicationsList');
            container.innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const snapshot = await db.collection('applications')
                    .orderBy('submittedAt', 'desc')
                    .limit(100)
                    .get();

                allApplications = [];
                snapshot.forEach(doc => {
                    allApplications.push({ id: doc.id, ...doc.data() });
                });

                filterApplications();
            } catch (error) {
                container.innerHTML = `<div class="error">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        function filterApplications() {
            const filter = document.getElementById('appStatusFilter').value;
            let filtered = allApplications;
            if (filter !== 'all') {
                filtered = allApplications.filter(a => a.status === filter);
            }

            document.getElementById('appTotalCount').innerHTML =
                `ì´ <strong>${filtered.length}</strong>ê±´`;
            renderApplicationsList(document.getElementById('applicationsList'), filtered);
        }

        function renderApplicationsList(container, apps) {
            if (apps.length === 0) {
                container.innerHTML = '<div class="empty">ì ‘ìˆ˜ëœ ì‹ ì²­ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const statusLabels = {
                'new': '<span class="app-badge app-new">ì‹ ê·œ</span>',
                'checked': '<span class="app-badge app-checked">í™•ì¸</span>',
                'contacted': '<span class="app-badge app-contacted">ì—°ë½ì™„ë£Œ</span>'
            };

            let html = `
                <table class="article-table">
                    <thead>
                        <tr>
                            <th class="col-num">ë²ˆí˜¸</th>
                            <th class="col-status">ìƒíƒœ</th>
                            <th class="col-program">ì‚¬ì—…ëª…</th>
                            <th class="col-name">ì´ë¦„</th>
                            <th class="col-phone">ì—°ë½ì²˜</th>
                            <th class="col-date">ì ‘ìˆ˜ì¼</th>
                            <th class="col-actions">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            apps.forEach((app, index) => {
                const badge = statusLabels[app.status] || statusLabels['new'];
                const num = apps.length - index;

                html += `
                    <tr class="${app.status === 'new' ? 'row-new' : ''}">
                        <td class="col-num">${num}</td>
                        <td class="col-status">${badge}</td>
                        <td class="col-program">${escapeHtml(app.programType)}</td>
                        <td class="col-name"><a href="#" onclick="viewApplication('${app.id}'); return false;">${escapeHtml(app.name)}</a></td>
                        <td class="col-phone">${escapeHtml(app.phone)}</td>
                        <td class="col-date">${app.date || '-'}</td>
                        <td class="col-actions">
                            <button class="btn-edit" onclick="viewApplication('${app.id}')">ìƒì„¸</button>
                            <button class="btn-delete" onclick="deleteApplication('${app.id}')">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function viewApplication(id) {
            const app = allApplications.find(a => a.id === id);
            if (!app) return;

            document.getElementById('applicationsView').style.display = 'none';
            document.getElementById('appDetailView').style.display = 'block';

            const statusOptions = ['new', 'checked', 'contacted'];
            const statusLabels = { 'new': 'ì‹ ê·œ', 'checked': 'í™•ì¸ì™„ë£Œ', 'contacted': 'ì—°ë½ì™„ë£Œ' };
            const statusSelect = statusOptions.map(s =>
                `<option value="${s}" ${app.status === s ? 'selected' : ''}>${statusLabels[s]}</option>`
            ).join('');

            document.getElementById('appDetailContent').innerHTML = `
                <table class="form-table">
                    <tbody>
                        <tr><th>ì ‘ìˆ˜ì¼ì‹œ</th><td>${app.submittedAt || app.date || '-'}</td></tr>
                        <tr><th>ìƒíƒœ</th><td>
                            <select id="appStatusSelect" class="status-select">${statusSelect}</select>
                            <button class="btn-status-save" onclick="updateAppStatus('${app.id}')">ì €ì¥</button>
                        </td></tr>
                        <tr><th>ì°¸ì—¬í¬ë§ ì‚¬ì—…ëª…</th><td><strong>${escapeHtml(app.programType)}</strong></td></tr>
                        <tr><th>ì´ë¦„</th><td>${escapeHtml(app.name)}</td></tr>
                        <tr><th>ì—°ë½ì²˜</th><td><a href="tel:${app.phone}">${escapeHtml(app.phone)}</a></td></tr>
                        <tr><th>ìƒë…„ì›”ì¼</th><td>${escapeHtml(app.birthDate || '-')}</td></tr>
                        <tr><th>ê¸°ì´ˆìƒí™œ ìˆ˜ê¸‰ì</th><td>${escapeHtml(app.basicLiving || '-')}</td></tr>
                        <tr><th>ê¸°ì´ˆì—°ê¸ˆ ìˆ˜ê¸‰ì</th><td>${escapeHtml(app.basicPension || '-')}</td></tr>
                        <tr><th>ì°¨ìƒìœ„ê³„ì¸µ</th><td>${escapeHtml(app.nearPoverty || '-')}</td></tr>
                        <tr><th>ë‚¨ê¸°ì‹  ë§ì”€</th><td>${escapeHtml(app.message) || '<span style="color:#999">ì—†ìŒ</span>'}</td></tr>
                    </tbody>
                </table>
                <div class="form-actions" style="margin-top:20px;">
                    <button class="btn-cancel" onclick="backToAppList()">â† ëª©ë¡ìœ¼ë¡œ</button>
                    <button class="btn-delete" onclick="deleteApplication('${app.id}')">ì‚­ì œ</button>
                </div>
            `;

            // ì‹ ê·œì¸ ê²½ìš° ìë™ìœ¼ë¡œ 'í™•ì¸ì™„ë£Œ'ë¡œ ë³€ê²½
            if (app.status === 'new') {
                db.collection('applications').doc(app.id).update({ status: 'checked' })
                    .then(() => {
                        app.status = 'checked';
                        document.getElementById('appStatusSelect').value = 'checked';
                        loadAppCount();
                    }).catch(() => { });
            }
        }

        async function updateAppStatus(id) {
            const newStatus = document.getElementById('appStatusSelect').value;
            try {
                await db.collection('applications').doc(id).update({ status: newStatus });
                const app = allApplications.find(a => a.id === id);
                if (app) app.status = newStatus;
                alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAppCount();
            } catch (error) {
                alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function deleteApplication(id) {
            if (!confirm('ì´ ì‹ ì²­ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await db.collection('applications').doc(id).delete();
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                backToAppList();
                loadApplications();
                loadAppCount();
            } catch (error) {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        function backToAppList() {
            document.getElementById('appDetailView').style.display = 'none';
            document.getElementById('applicationsView').style.display = 'block';
        }

        async function loadAppCount() {
            try {
                const snapshot = await db.collection('applications').where('status', '==', 'new').get();
                const countEl = document.getElementById('count-applications');
                countEl.textContent = snapshot.size;
                countEl.classList.toggle('has-new', snapshot.size > 0);
            } catch (e) { /* ë¬´ì‹œ */ }
        }

        // switchBoard ì˜¤ë²„ë¼ì´ë“œ - ì‹ ì²­ì„œ ë·° ìˆ¨ê¸°ê¸°
        const _origSwitchBoard = switchBoard;
        switchBoard = function (board, el) {
            document.getElementById('applicationsView').style.display = 'none';
            document.getElementById('appDetailView').style.display = 'none';
            _origSwitchBoard(board, el);
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹ ì²­ì„œ ì¹´ìš´íŠ¸ë„ ë¡œë“œ
        const _origOnAuth = auth.onAuthStateChanged;
        auth.onAuthStateChanged(user => {
            if (user && ALLOWED_ADMINS.includes(user.email)) {
                loadAppCount();
            }
        });
    </script>
</body>

</html>